<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | DiplomacyLedger</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    
    <link rel="stylesheet" href="custom.css"> 
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>DiplomacyLedger Dashboard</h2>
            <button class="btn btn-sm btn-danger" onclick="localStorage.clear(); window.location.href='index.html'">Logout</button>
        </div>

        <div class="d-flex justify-content-end mb-4">
             <button id="create-new-button" class="btn btn-success me-3 d-none" onclick="alert('TODO: Implement creation form/API call');">
                + Create New Treaty
            </button>
            <button id="trigger-check-button" class="btn btn-danger d-none" onclick="triggerExpiryCheck()">
                Check Expiring Treaties
            </button>
        </div>
        
        <div id="dashboard-stats" class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">Status Distribution (FR-RP-2)</div>
                    <ul id="status-report-list" class="list-group list-group-flush">
                        <li class="list-group-item">Loading status counts...</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">Expiring Soon (Next 6 Months) (FR-RP-4)</div>
                    <ul id="expiry-report-list" class="list-group list-group-flush">
                        <li class="list-group-item">Loading expiring list...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">Advanced Search & Filters</div>
            <div class="card-body">
                <form id="filter-form" onsubmit="event.preventDefault(); fetchTreaties()">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="search-term" class="form-label">Title/Country Search</label>
                            <input type="text" class="form-control" id="search-term" placeholder="e.g., Trade, China, Protocol">
                        </div>
                        <div class="col-md-3">
                            <label for="filter-status" class="form-label">Status</label>
                            <select class="form-select" id="filter-status">
                                <option value="">Any Status</option>
                                <option value="Draft">Draft</option><option value="Signed">Signed</option>
                                <option value="Enforced">Enforced</option><option value="Archived">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-category" class="form-label">Category</label>
                            <select class="form-select" id="filter-category">
                                <option value="">Any Category</option>
                                <option value="Commerce">Commerce</option><option value="Security">Security</option>
                                <option value="Tech">Tech</option><option value="Education">Education</option>
                                <option value="Environment">Environment</option><option value="Agriculture">Agriculture</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Search</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <h3>Active Treaty Records</h3>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Signatories</th>
                    <th>Expiry Date</th>
                </tr>
            </thead>
            <tbody id="treaty-list">
                <tr><td colspan="4">Loading treaties...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="app.js"></script>
    <script>
        // Run all necessary functions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in
            if (!localStorage.getItem('userToken')) {
                window.location.href = 'index.html';
                return;
            }
            
            // Show Admin buttons if applicable (already handled in app.js, but explicitly here too)
            if (localStorage.getItem('userRole') === 'admin') {
                document.getElementById('create-new-button').classList.remove('d-none');
                document.getElementById('trigger-check-button').classList.remove('d-none');
            }

            // Fetch core data
            fetchTreaties();
            // Fetch reporting data
            fetchStatusCounts();
            fetchExpiringSoon();
        });
        
        // Ensure functions are globally accessible
        window.fetchTreaties = fetchTreaties;
        window.triggerExpiryCheck = triggerExpiryCheck; 
    </script>
</body>
</html>